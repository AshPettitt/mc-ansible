---
- hosts: localhost
  connection: local
  gather_facts: true
  become: true
  become_user: minecraft

  tasks:
    - name: Backup world
      include_role:
        name: roles/mc-config
        tasks_from: mc-backup.yml
      tags:
        - upgrade
        - backup

    - name: Backup sync
      include_role:
        name: roles/mc-config
        tasks_from: mc-s3sync.yml
      vars:
        SYNC_SOURCE: /opt/minecraft/server/backups
      tags:
        - upgrade
        - backup

    - name: Stop Minecraft service
      include_role:
        name: roles/mc-config
        tasks_from: mc-service.yml
      vars:
        SERVICE_STATE: stop
      tags:
        - upgrade
        - service_stop

    - name: Clean up existing modpack
      include_role:
        name: roles/mc-config
        tasks_from: mc-upgrade-prep.yml
      vars:
        keep_these:
          - /opt/minecraft/server/backups
          - /opt/minecraft/server/world
          - /opt/minecraft/server/eula.txt
          - /opt/minecraft/server/server.properties
          - /opt/minecraft/server/whitelist.json
      tags:
        - upgrade

    - name: Setup modpack
      include_role:
        name: roles/mc-config
        tasks_from: mc-modpack.yml
      tags:
        - upgrade

    - name: Start Minecraft service
      include_role:
        name: roles/mc-config
        tasks_from: mc-service.yml
      vars:
        SERVICE_STATE: start
      tags:
        - upgrade
        - service_start
